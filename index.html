<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simple Playlist Extractor — Emerald (FIXED)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .row-hover:hover{background:rgba(0,0,0,0.03);} 
    .drop-active{ border-color: #059669 !important; background: rgba(5,150,105,0.06); }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-4xl mx-auto p-6 space-y-6">
    <section class="bg-white rounded-2xl shadow overflow-hidden">
      <!-- Emerald accent strip (24px) -->
      <div class="h-6 bg-emerald-700"></div>

      <!-- Card content -->
      <div class="p-6 space-y-4">
        <h1 class="text-xl font-bold">Simple Playlist Extractor</h1>

        <!-- Status / Error -->
        <div id="status" class="hidden rounded-lg border border-blue-300 bg-blue-50 text-blue-800 p-3 text-sm"></div>
        <div id="error" class="hidden rounded-lg border border-red-300 bg-red-50 text-red-800 p-3 text-sm"></div>

        <!-- Controls -->
        <div class="grid md:grid-cols-2 gap-4">
          <!-- File picker + actions (centered stacked, dotted gray border, drag & drop) -->
          <div id="dropZone" class="rounded-lg border-2 border-dotted border-gray-300 flex flex-col items-center justify-center gap-3 p-8 text-center transition-colors">
            <p class="text-lg text-gray-800">Drop .jwlplaylist / .jwlibrary here</p>
            <span class="text-sm text-gray-500">or</span>
            <label class="inline-block">
              <!-- NOTE: accept fixed to include ".jwlibrary" with a dot -->
              <input type="file" id="fileInput" accept=".jwlplaylist,.jwlibrary" class="hidden">
              <span class="px-4 py-2 rounded-lg bg-emerald-600 text-white cursor-pointer hover:bg-emerald-700">Choose file…</span>
            </label>
            <p class="text-xs text-gray-600" id="fileName">File: —</p>
            <div class="flex gap-2">
              <button id="extractBtn" type="button" class="px-4 py-2 rounded-lg bg-emerald-700 text-white hover:bg-emerald-800 disabled:opacity-50" disabled>Extract</button>
            </div>
          </div>

          <!-- View & Filter options -->
          <div class="rounded-xl p-4 border space-y-3">
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="toggleChecklist" type="checkbox" class="h-4 w-4 rounded border-gray-300">
              <span>Show as checklist</span>
            </label>

            <!-- Include marker labels toggle (off by default) -->
            <label class="block inline-flex items-center gap-2 text-sm">
              <input id="toggleMarkers" type="checkbox" class="h-4 w-4 rounded border-gray-300">
              <span>Include marker labels (PlaylistItemMarker.Label)</span>
            </label>

            <div class="text-sm">
              <div class="font-medium mb-1">Show:</div>
              <div class="flex flex-wrap gap-3">
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="showMode" value="all" class="h-4 w-4" checked> <span>All</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="showMode" value="filtered" class="h-4 w-4"> <span>Filtered</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="showMode" value="custom" class="h-4 w-4"> <span>Custom</span>
                </label>
              </div>
            </div>

            <!-- Custom controls -->
            <div id="customControls" class="space-y-2 hidden">
              <div class="text-xs text-gray-600">Enter comma‑separated values.</div>
              <div class="grid grid-cols-1 gap-2">
                <label class="text-sm">
                  <span class="block mb-1">Prefix (starts with):</span>
                  <input id="customPrefixes" class="w-full rounded-md border p-2" placeholder="Title, Subheading, Q, …">
                </label>
                <label class="text-sm">
                  <span class="block mb-1">Exact (match exactly):</span>
                  <input id="customExacts" class="w-full rounded-md border p-2" placeholder="Opening song, Closing song, …">
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Diagnostics summary row (right aligned) with standalone big copy icon -->
        <div class="w-full flex justify-end items-center gap-2">
          <div id="diagTop" class="inline-flex items-center gap-2 text-xs bg-gray-50 border border-gray-200 rounded-full px-3 py-1 shadow-sm"></div>
          <button id="copyTable" class="inline-flex items-center justify-center h-8 w-8 rounded-full border border-gray-200 bg-white hover:bg-gray-50 active:bg-gray-100 shadow-sm"
                  title="Copy results" aria-label="Copy results">
            <svg id="copyTableIcon" xmlns="http://www.w3.org/2000/svg" class="h-4.5 w-4.5 text-gray-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          </button>
        </div>

        <!-- Extracted Data Display -->
        <div id="checklist" class="space-y-2 mt-2"></div>
      </div>
    </section>
  </div>

  <!-- JSZip + sql.js -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sql.js@1.9.0/dist/sql-wasm.js"></script>

<script>
const $ = (sel) => document.querySelector(sel);
const statusEl = $("#status");
const errorEl = $("#error");
const diagTopEl = $("#diagTop");
const copyTableBtn = $("#copyTable");
let copyTableIcon = $("#copyTableIcon");
function showStatus(msg){ statusEl.textContent = msg || ""; statusEl.classList.toggle("hidden", !msg); }
function showError(msg){ errorEl.textContent = msg || ""; errorEl.classList.toggle("hidden", !msg); if (msg) showStatus(""); }
function showDiagTopHTML(count, sources){
  const text = `Detected labels: ${count} — Sources → ${sources}`;
  diagTopEl.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-emerald-700" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.75a.75.75 0 10-1.5 0v4.25a.75.75 0 001.5 0V6.25zM10 14a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
    </svg>
    <span class="font-medium text-gray-700">${text}</span>
  `;
}

// Elements
const dropZone = $("#dropZone");
const fileInput = $("#fileInput");
const fileName = $("#fileName");
const extractBtn = $("#extractBtn");
const checklistEl = $("#checklist");
const toggleChecklist = $("#toggleChecklist");
const toggleMarkers = $("#toggleMarkers");
const customControls = $("#customControls");
const customPrefixes = $("#customPrefixes");
const customExacts = $("#customExacts");
const showModeInputs = document.getElementsByName("showMode");

let pickedFile = null;
let SQL_INIT_OK = false;
let latestRaw = { base: [], markers: [], diagBase: '', diagMarkers: '', diagFallback: '' };
let latestData = []; // flattened + filtered view

// Persistence helpers
const LS = {
  get(k, fallback=null){ try { const v = localStorage.getItem(k); return v===null? fallback : JSON.parse(v); } catch(_){ return fallback; } },
  set(k, v){ try { localStorage.setItem(k, JSON.stringify(v)); } catch(_){} }
};

const DEFAULT_EXCLUDE_PREFIXES = ["Title", "Title Page", "Subheading", "Q", "R", "Review"];
const STATE_KEYS = {
  asChecklist: "pe.asChecklist",
  includeMarkers: "pe.includeMarkers",
  showMode: "pe.showMode",
  customPrefixes: "pe.customPrefixes",
  customExacts: "pe.customExacts",
  checks: "pe.checks"
};

// Global error capture
window.addEventListener('error', (e) => showError((e.error && e.error.message) ? e.error.message : (e.message || 'Unexpected error')));
window.addEventListener('unhandledrejection', (e) => showError((e && e.reason && (e.reason.message || e.reason)) || 'Unhandled promise rejection'));

// Init sql.js
(async function initSQL(){
  try {
    showStatus("Loading SQL engine...");
    if (typeof initSqlJs !== 'function') throw new Error('initSqlJs is not available (CDN blocked?)');
    window.SQL = await initSqlJs({ locateFile: f => "https://cdn.jsdelivr.net/npm/sql.js@1.9.0/dist/" + f });
    SQL_INIT_OK = !!window.SQL;
    if (!SQL_INIT_OK) throw new Error("sql.js failed to initialize.");
    showStatus("SQL ready.");
  } catch (err) {
    SQL_INIT_OK = false;
    showError("SQL init error: " + (err && err.message ? err.message : String(err)) + " — The Extract button will not work until this loads.");
  }
})();

// Restore persisted UI state
function restoreUIState(){
  toggleChecklist.checked = !!LS.get(STATE_KEYS.asChecklist, false);
  toggleMarkers.checked = !!LS.get(STATE_KEYS.includeMarkers, false); // default OFF
  const showMode = LS.get(STATE_KEYS.showMode, "all");
  [...showModeInputs].forEach(inp => inp.checked = (inp.value === showMode));
  customPrefixes.value = (LS.get(STATE_KEYS.customPrefixes, "") || "");
  customExacts.value = (LS.get(STATE_KEYS.customExacts, "") || "");
  customControls.classList.toggle("hidden", showMode !== "custom");
}
restoreUIState();

function persistUIState(){
  LS.set(STATE_KEYS.asChecklist, !!toggleChecklist.checked);
  LS.set(STATE_KEYS.includeMarkers, !!toggleMarkers.checked);
  const sel = [...showModeInputs].find(i => i.checked)?.value || 'all';
  LS.set(STATE_KEYS.showMode, sel);
  LS.set(STATE_KEYS.customPrefixes, customPrefixes.value || "");
  LS.set(STATE_KEYS.customExacts, customExacts.value || "");
}

// Load .zip and open DB
async function loadZipAndDb(file){
  if (!SQL_INIT_OK) throw new Error("SQL engine not ready (check internet connection).");
  showStatus("Reading archive...");
  const zip = await JSZip.loadAsync(file);
  // Try common names, else first .db file
  const tryNames = ["userData.db", "UserData.db", "userdata.db", "jwpub.db", "data.db"];
  let dbEntry = null;
  for (const name of tryNames){
    const f = zip.file(name);
    if (f && f.length) { dbEntry = f[0]; break; }
  }
  if (!dbEntry){
    const anyDb = zip.file(/\.db$/i)[0];
    if (!anyDb) throw new Error("No .db file found inside the archive.");
    dbEntry = anyDb;
  }
  const buf = await dbEntry.async("arraybuffer");
  const db = new SQL.Database(new Uint8Array(buf));
  return db;
}

// Extract labels
function extractRawLabels(db){
  const q = (sql) => {
    try{ return db.exec(sql); } catch(_){ return []; }
  };
  const rowsToStrings = (res) => (res && res[0] && res[0].values ? res[0].values.map(v => (v && v[0] !== null ? String(v[0]) : '')) : []);

  const baseRes = q("SELECT Label FROM PlaylistItem WHERE Label IS NOT NULL");
  const markerRes = q("SELECT Label FROM PlaylistItemMarker WHERE Label IS NOT NULL");

  const base = rowsToStrings(baseRes);
  const markers = rowsToStrings(markerRes);

  return {
    base,
    markers,
    diagBase: `PlaylistItem: ${base.length}`,
    diagMarkers: `PlaylistItemMarker: ${markers.length}`,
    diagFallback: ''
  };
}

function uniq(arr){ return [...new Set(arr.filter(Boolean))]; }

function applyFilters(all){
  const showMode = [...showModeInputs].find(i => i.checked)?.value || 'all';
  const includeMarkers = !!toggleMarkers.checked;
  const prefixes = customPrefixes.value.split(',').map(s => s.trim()).filter(Boolean);
  const exacts = customExacts.value.split(',').map(s => s.trim()).filter(Boolean);

  // Base set
  let combined = [...all.base];
  if (includeMarkers) combined.push(...all.markers);

  // Default filtered view (excludes noisy prefixes)
  if (showMode === 'filtered'){
    const drop = new Set([...DEFAULT_EXCLUDE_PREFIXES.map(p=>p.toLowerCase()), ...prefixes.map(p=>p.toLowerCase())]);
    combined = combined.filter(x => x && ![...drop].some(p => x.toLowerCase().startsWith(p + ' ')));
  }

  // Custom view
  if (showMode === 'custom'){
    const wantPrefix = prefixes.map(p=>p.toLowerCase());
    const wantExact = new Set(exacts.map(e=>e.toLowerCase()));
    combined = combined.filter(x => {
      const t = x.toLowerCase();
      const matchPrefix = !wantPrefix.length || wantPrefix.some(p => t.startsWith(p + ' '));
      const matchExact = !wantExact.size || wantExact.has(t);
      return matchPrefix || matchExact;
    });
  }

  return uniq(combined);
}

function getChecks(){ return LS.get(STATE_KEYS.checks, {}); }
function setChecks(v){ LS.set(STATE_KEYS.checks, v || {}); }

function renderAllData(){
  checklistEl.innerHTML = '';
  const sources = [latestRaw.diagBase, latestRaw.diagMarkers, latestRaw.diagFallback].filter(Boolean).join(' · ');
  const labels = applyFilters(latestRaw);
  showDiagTopHTML(labels.length, sources || '—');

  const asChecklist = !!toggleChecklist.checked;
  latestData = labels.map(l => ({label: l}));

  if (labels.length === 0){
    const empty = document.createElement('div');
    empty.className = "text-sm text-gray-500";
    empty.textContent = "No labels found.";
    checklistEl.appendChild(empty);
    return;
  }

  const table = document.createElement('table');
  table.className = "w-1/2 border border-emerald-600 rounded-lg overflow-hidden text-sm";

  if (!asChecklist){
    labels.forEach((txt, idx) => {
      const row = document.createElement('tr');
      row.className = idx % 2 === 0 ? "bg-gray-50" : "bg-white";

      const cell = document.createElement('td');
      cell.className = "px-3 py-2 border-b border-gray-200";
      cell.textContent = txt;

      row.appendChild(cell);
      table.appendChild(row);
    });
    checklistEl.appendChild(table);
    return;
  }

  const checks = getChecks();
  labels.forEach((txt, idx) => {
    const row = document.createElement('tr');
    row.className = idx % 2 === 0 ? "bg-gray-50" : "bg-white";

    const cell = document.createElement('td');
    cell.className = "px-3 py-2 border-b border-gray-200 flex items-center";

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.className = "mr-2";
    cb.checked = !!checks[txt];

    cb.addEventListener('change', () => {
      const updated = getChecks();
      if (cb.checked) updated[txt] = true; else delete updated[txt];
      setChecks(updated);
    });

    cell.appendChild(cb);
    const span = document.createElement('span');
    span.textContent = txt;
    cell.appendChild(span);

    row.appendChild(cell);
    table.appendChild(row);
  });
  checklistEl.appendChild(table);
}

// Extract action
async function doExtract(){
  try {
    showError(""); showDiagTopHTML(0, ""); showStatus("Opening package...");
    if (!pickedFile){ showError("No file selected — choose or drop a .jwlplaylist / .jwlibrary first."); return; }
    if (!SQL_INIT_OK){ showError("SQL engine not ready — reload the page or check network to the CDN."); return; }
    extractBtn.disabled = true; extractBtn.textContent = "Extracting…";

    const db = await loadZipAndDb(pickedFile);
    latestRaw = extractRawLabels(db);

    renderAllData();
    const total = latestData.length;
    showStatus(total ? "Done. Data extracted." : "Done. No labels found.");
  } catch (err) {
    console.error(err);
    showError((err && err.message ? err.message : String(err)) + " — See console for details.");
  } finally {
    extractBtn.disabled = false; extractBtn.textContent = "Extract";
  }
}

// File input + drag & drop handling
fileInput.addEventListener("change", async (e) => {
  const f = e.target.files && e.target.files[0];
  if (f){
    pickedFile = f;
    fileName.textContent = "File: " + f.name + " (" + (f.size/1024).toFixed(1) + " KB)";
    extractBtn.disabled = false;
  }
});

["dragenter","dragover"].forEach(evt => {
  dropZone.addEventListener(evt, (e) => {
    e.preventDefault(); e.stopPropagation();
    dropZone.classList.add("drop-active");
  });
});
["dragleave","drop"].forEach(evt => {
  dropZone.addEventListener(evt, (e) => {
    e.preventDefault(); e.stopPropagation();
    dropZone.classList.remove("drop-active");
  });
});

dropZone.addEventListener("drop", (e) => {
  const dt = e.dataTransfer;
  if (!dt || !dt.files || dt.files.length === 0) return;
  const f = dt.files[0];
  const ok = /\.jwlplaylist$|\.jwlibrary$/i.test(f.name);
  if (!ok){
    showError("Unsupported file type. Please drop a .jwlplaylist or .jwlibrary file.");
    return;
  }
  pickedFile = f;
  fileName.textContent = "File: " + f.name + " (" + (f.size/1024).toFixed(1) + " KB)";
  extractBtn.disabled = false;
});

// ✅ FIX: Wire up Extract button
extractBtn.addEventListener('click', doExtract);

// UI listeners -> persist state
[toggleChecklist, toggleMarkers, customPrefixes, customExacts].forEach(el => {
  el.addEventListener('input', () => { persistUIState(); renderAllData(); });
});
[...showModeInputs].forEach(inp => {
  inp.addEventListener('change', () => {
    persistUIState();
    customControls.classList.toggle('hidden', inp.value !== 'custom' || !inp.checked);
    renderAllData();
  });
});

// Copy results (plain text)
copyTableBtn.addEventListener('click', async () => {
  try{
    const labels = latestData.map(o => o.label).join('\n');
    await navigator.clipboard.writeText(labels);
    // flash icon
    copyTableIcon.outerHTML = '<svg id="copyTableIcon" xmlns="http://www.w3.org/2000/svg" class="h-4.5 w-4.5 text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M20 6L9 17l-5-5"/></svg>';
    copyTableIcon = document.getElementById('copyTableIcon');
    setTimeout(()=>{ copyTableIcon.outerHTML = '<svg id="copyTableIcon" xmlns="http://www.w3.org/2000/svg" class="h-4.5 w-4.5 text-gray-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>'; copyTableIcon = document.getElementById('copyTableIcon'); }, 900);
  }catch(e){ showError('Copy failed: ' + (e && e.message ? e.message : e)); }
});
// ---- NWT Bible catalog integration ----
let NWT = { db: null, ready: false, tables: new Set() };
async function initNWT(){
  try{
    if (!window.SQL){ return; }
    const res = await fetch('nwt_ASL.db');
    if (!res.ok){ console.warn('NWT DB not found (optional):', res.status); return; }
    const buf = new Uint8Array(await res.arrayBuffer());
    NWT.db = new SQL.Database(buf);
    // discover tables
    try{
      const t = NWT.db.exec("SELECT name FROM sqlite_master WHERE type='table'");
      const names = (t && t[0] && t[0].values ? t[0].values.map(r=>String(r[0])):[]);
      NWT.tables = new Set(names);
    }catch(_){}
    NWT.ready = true;
    showStatus((statusEl.textContent? statusEl.textContent + ' · ' : '') + 'Bible catalog ready');
  }catch(e){ console.warn('NWT init failed:', e); }
}

function nwtQuery(sql, params=[]){ try{ return NWT.db.exec(sql, params); } catch(_){ return []; } }

function resolveBookName(bookNumber){
  if (!NWT.ready) return null;
  // Try common schemas
  let r = nwtQuery("SELECT Name FROM BibleBook WHERE BookNumber=? LIMIT 1", [bookNumber]);
  if (r && r[0] && r[0].values && r[0].values[0]) return String(r[0].values[0][0]);
  r = nwtQuery("SELECT Title FROM Book WHERE BookNumber=? LIMIT 1", [bookNumber]);
  if (r && r[0] && r[0].values && r[0].values[0]) return String(r[0].values[0][0]);
  r = nwtQuery("SELECT StandardName FROM BibleBook WHERE BookNumber=? LIMIT 1", [bookNumber]);
  if (r && r[0] && r[0].values && r[0].values[0]) return String(r[0].values[0][0]);
  return null;
}

function getVerseRefFromTables(verseId){
  // Try a few likely schemas
  let r = nwtQuery("SELECT BookNumber, ChapterNumber, VerseNumber FROM Verse WHERE VerseId=? LIMIT 1", [verseId]);
  if (r && r[0] && r[0].values && r[0].values[0]){ const [b,c,v]=r[0].values[0]; return {book:Number(b),chapter:Number(c),verse:Number(v)}; }
  r = nwtQuery("SELECT BookNumber, ChapterNumber, VerseNumber FROM BibleVerse WHERE VerseId=? LIMIT 1", [verseId]);
  if (r && r[0] && r[0].values && r[0].values[0]){ const [b,c,v]=r[0].values[0]; return {book:Number(b),chapter:Number(c),verse:Number(v)}; }
  r = nwtQuery("SELECT BookNumber, ChapterNumber, Verse FROM VerseIndex WHERE VerseId=? LIMIT 1", [verseId]);
  if (r && r[0] && r[0].values && r[0].values[0]){ const [b,c,v]=r[0].values[0]; return {book:Number(b),chapter:Number(c),verse:Number(v)}; }
  return null;
}

function formatVerse(vid){
  if (!vid && vid!==0) return '';
  let ref = null;
  if (NWT.ready){ ref = getVerseRefFromTables(vid); }
  if (!ref){ return 'VerseId ' + vid; }
  const name = resolveBookName(ref.book) || ('Book ' + ref.book);
  return name + ' ' + ref.chapter + ':' + ref.verse;
}

function extractVersesFromPackageDB(db){
  const q = (sql)=>{ try{ return db.exec(sql); }catch(_){ return []; } };
  // Try multiple join patterns to collect marker label + verse ids
  let res = q("SELECT m.Label, v.VerseId FROM PlaylistItemMarker m JOIN MarkerBibleVerseMap v ON v.MarkerId = m.Id");
  if (!(res && res[0] && res[0].values && res[0].values.length)){
    res = q("SELECT m.Label, v.VerseId FROM PlaylistItemMarker m JOIN BibleVerseMap v ON v.MarkerId = m.Id");
  }
  if (!(res && res[0] && res[0].values && res[0].values.length)){
    // Some exports store verse map on PlaylistItem -> try generic lookup if a VerseId column exists anywhere
    res = q("SELECT Label, VerseId FROM PlaylistItemMarker WHERE VerseId IS NOT NULL");
  }
  const out = [];
  const rows = (res && res[0] && res[0].values) ? res[0].values : [];
  for (const row of rows){
    const lbl = row[0] != null ? String(row[0]) : '';
    const vid = row[1] != null ? Number(row[1]) : null;
    if (vid != null) out.push({ label: lbl, verseId: vid, ref: formatVerse(vid) });
  }
  return out;
}

// Extend doExtract to also collect/display Bible refs
const _doExtract_orig = doExtract;
async function doExtract(){
  await _doExtract_orig.apply(this, arguments);
  try{
    if (!pickedFile) return;
    const db = await loadZipAndDb(pickedFile);
    const verses = extractVersesFromPackageDB(db);
    if (verses.length){
      // Render a compact list under the table
      const wrap = document.createElement('div');
      wrap.className = 'mt-3 rounded-lg border border-gray-200 bg-white p-3';
      const h = document.createElement('div');
      h.className = 'text-sm font-semibold text-gray-700 mb-2';
      h.textContent = 'Bible references found (' + verses.length + ')';
      wrap.appendChild(h);
      const ul = document.createElement('ul');
      ul.className = 'text-sm space-y-1';
      verses.slice(0,300).forEach(v => {
        const li = document.createElement('li');
        li.innerHTML = '<span class="font-medium">' + (v.ref || ('VerseId ' + v.verseId)) + '</span>' + (v.label? ' — <span class="text-gray-700">'+ v.label.replace(/</g,'&lt;') +'</span>' : '');
        ul.appendChild(li);
      });
      wrap.appendChild(ul);
      checklistEl.appendChild(wrap);
    }
  }catch(e){ console.warn('Verse extraction failed:', e); }
}

// Kick off optional NWT load after SQL init settles
setTimeout(()=>{ initNWT(); }, 1000);

</script>
</body>
</html>
